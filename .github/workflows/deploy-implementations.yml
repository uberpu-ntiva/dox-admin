name: Create Implementation PRs deploy-implementations.yml

on:
  workflow_dispatch:
    inputs:
      repository:
        description: 'Repository to create PR for (or "all" for all changes)'
        required: false
        default: 'all'
      branch_prefix:
        description: 'Branch prefix to check (e.g., "compyle/", "feature/")'
        required: false
        default: 'compyle/'
      auto_merge:
        description: 'Auto-merge PR if checks pass'
        required: false
        type: boolean
        default: false

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      repositories: ${{ steps.detect.outputs.repositories }}
    steps:
      - name: Checkout dox-admin
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          fetch-depth: 0

      - name: Detect changed repositories
        id: detect
        run: |
          REPO_LIST=$(cat << 'EOF'
          [
            "dox-tmpl-pdf-upload",
            "dox-mcp-server",
            "dox-core-auth",
            "dox-core-store",
            "dox-tmpl-service",
            "dox-tmpl-field-mapper",
            "dox-tmpl-pdf-recognizer"
          ]
          EOF
          )

          echo "repositories=$REPO_LIST" >> $GITHUB_OUTPUT
          echo "Detected repositories: $REPO_LIST"

  create-prs:
    needs: detect-changes
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repository: ${{ fromJson(needs.detect-changes.outputs.repositories) }}
      max-parallel: 2
    steps:
      - name: Checkout dox-admin
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          path: dox-admin
          fetch-depth: 0

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/${{ matrix.repository }}
          path: ${{ matrix.repository }}
          fetch-depth: 0
        continue-on-error: true

      - name: Check for implementation branch
        id: check-branch
        run: |
          cd ${{ matrix.repository }}

          # List all branches
          BRANCHES=$(git branch -r | grep "${{ github.event.inputs.branch_prefix }}" || true)

          if [ -z "$BRANCHES" ]; then
            echo "found=false" >> $GITHUB_OUTPUT
            echo "No implementation branches found"
            exit 0
          fi

          # Get the first implementation branch
          BRANCH=$(echo "$BRANCHES" | head -1 | xargs)
          echo "found=true" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "Found branch: $BRANCH"

      - name: Check for differences
        if: steps.check-branch.outputs.found == 'true'
        id: diff
        run: |
          cd ${{ matrix.repository }}

          BRANCH="${{ steps.check-branch.outputs.branch }}"
          BRANCH_NAME=${BRANCH#origin/}

          # Count commits ahead
          COMMITS=$(git rev-list main..$BRANCH_NAME --count 2>/dev/null || echo "0")

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "commits_ahead=$COMMITS" >> $GITHUB_OUTPUT
          echo "Commits ahead: $COMMITS"

          if [ "$COMMITS" -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Get commit details
        if: steps.diff.outputs.has_changes == 'true'
        id: commits
        run: |
          cd ${{ matrix.repository }}

          BRANCH_NAME="${{ steps.diff.outputs.branch_name }}"

          # Get commit messages
          COMMITS=$(git log main..$BRANCH_NAME --oneline | head -10)

          # Create PR title from most recent commit
          TITLE=$(git log main..$BRANCH_NAME -1 --format=%s)

          # Create PR body
          BODY=$(cat << 'EOF'
          ## Implementation Summary

          Automated PR from implementation branch: ${{ steps.diff.outputs.branch_name }}

          ### Commits
          EOF
          )

          BODY="$BODY"$'\n```\n'"$COMMITS"$'\n```\n'

          BODY="$BODY"$'\n### Changes\n'

          # Get changed files
          FILES=$(git diff --name-only main..$BRANCH_NAME)
          BODY="$BODY"$'\n```\n'"$FILES"$'\n```\n'

          BODY="$BODY"$'\n### Generated with Compyle\n'
          BODY="$BODY"$'\nGenerated with [Compyle](https://compyle.dev) automation framework.\n'

          # Escape for JSON
          TITLE_JSON=$(echo "$TITLE" | jq -R -s '.')
          BODY_JSON=$(echo "$BODY" | jq -R -s '.')

          echo "title=$TITLE_JSON" >> $GITHUB_OUTPUT
          echo "body=$BODY_JSON" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.diff.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        env:
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ matrix.repository }}
          BRANCH_NAME: ${{ steps.diff.outputs.branch_name }}
          COMMITS_AHEAD: ${{ steps.diff.outputs.commits_ahead }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = process.env.REPO_OWNER;
            const repo = process.env.REPO_NAME;
            const head = process.env.BRANCH_NAME;
            const base = 'main';

            console.log(`Creating PR for ${owner}/${repo}`);
            console.log(`Branch: ${head} â†’ ${base}`);

            try {
              // Check if PR already exists
              const { data: pulls } = await github.rest.pulls.list({
                owner,
                repo,
                state: 'open',
                head: `${owner}:${head}`,
                base: base
              });

              if (pulls.length > 0) {
                console.log(`PR already exists: ${pulls[0].html_url}`);
                return;
              }

              // Get commit info
              const { data: comparison } = await github.rest.repos.compareCommits({
                owner,
                repo,
                base: base,
                head: head
              });

              // Create PR title from commits
              const title = comparison.commits[0].commit.message.split('\n')[0];
              const commitsAhead = comparison.total_commits;

              // Build PR body
              let body = `## Implementation Summary\n\n`;
              body += `Automated PR from implementation branch: \`${head}\`\n\n`;
              body += `**Commits**: ${commitsAhead}\n\n`;

              body += `### Recent Commits\n\`\`\`\n`;
              comparison.commits.slice(0, 10).forEach(commit => {
                body += `${commit.sha.substring(0, 7)} - ${commit.commit.message.split('\n')[0]}\n`;
              });
              body += `\`\`\`\n\n`;

              body += `### Files Changed\n`;
              const fileCount = comparison.files.length;
              body += `${fileCount} file(s) changed\n\n`;

              if (fileCount <= 10) {
                body += `\`\`\`\n`;
                comparison.files.forEach(file => {
                  body += `${file.status.toUpperCase()} ${file.filename}\n`;
                });
                body += `\`\`\`\n\n`;
              }

              body += `---\n\n`;
              body += `ðŸ¤– Generated with [Compyle](https://compyle.dev)\n`;

              // Create PR
              const { data: pr } = await github.rest.pulls.create({
                owner,
                repo,
                title: title,
                head: head,
                base: base,
                body: body,
                draft: false
              });

              console.log(`âœ… PR Created: ${pr.html_url}`);

            } catch (error) {
              console.error(`Error creating PR for ${owner}/${repo}:`);
              console.error(error.message);

              // Don't fail the whole workflow
              if (error.status === 422) {
                console.log('PR may already exist or branch is invalid');
              }
            }

      - name: Comment PR with build info
        if: steps.diff.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        env:
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ matrix.repository }}
          BRANCH_NAME: ${{ steps.diff.outputs.branch_name }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = process.env.REPO_OWNER;
            const repo = process.env.REPO_NAME;
            const head = process.env.BRANCH_NAME;

            try {
              // Find the PR
              const { data: pulls } = await github.rest.pulls.list({
                owner,
                repo,
                state: 'open',
                head: `${owner}:${head}`,
                base: 'main'
              });

              if (pulls.length === 0) {
                console.log('PR not found');
                return;
              }

              const pr = pulls[0];

              // Add comment with build info
              const comment = `
## âœ… Implementation Status

- **Workflow**: Create Implementation PRs
- **Time**: ${new Date().toISOString()}
- **Repository**: \`${repo}\`
- **Branch**: \`${head}\`

### Next Steps
1. Review the changes
2. Run any required tests
3. Merge when ready

Generated with [Compyle](https://compyle.dev)
              `;

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pr.number,
                body: comment
              });

              console.log(`Comment added to PR #${pr.number}`);

            } catch (error) {
              console.log('Could not add comment (PR may not exist yet)');
            }

  notify:
    runs-on: ubuntu-latest
    needs: create-prs
    if: always()
    steps:
      - name: Workflow Summary
        run: |
          echo "## Implementation PR Workflow Complete âœ…"
          echo ""
          echo "### Summary"
          echo "- Detected repositories with implementation branches"
          echo "- Created PRs for branches with changes"
          echo "- Each PR includes:"
          echo "  - Commit history"
          echo "  - File changes"
          echo "  - Auto-generated description"
          echo ""
          echo "### Next Steps"
          echo "1. Review PRs on GitHub"
          echo "2. Run any required CI/CD checks"
          echo "3. Merge to main when ready"
